<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nh·∫≠t k√Ω ng√†y h·ªçc</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: Arial, sans-serif; background: #f0f4ff; display: flex; justify-content: center; padding: 20px; }
    .form-step { display: none; }
    .form-step.active { display: block; }
    form { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 100%; max-width: 600px; }
    h1 { text-align: center; color: #2563eb; }
    label { font-weight: bold; display: block; margin-top: 15px; margin-bottom: 5px; }
    input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
    input[type="checkbox"] { width: auto; margin-right: 6px; }
    input[type="range"] { width: 100%; }
    button { margin-top: 20px; background: #2563eb; color: white; border: none; padding: 12px; font-size: 16px; border-radius: 8px; cursor: pointer; }
    button:hover { background: #1e40af; }
    .emoji { font-size: 30px; text-align: center; margin-top: 10px; }
    #resultBox { display: none; background: #ecfdf5; border: 1px solid #10b981; color: #065f46; padding: 15px; border-radius: 8px; margin-top: 20px; }
  </style>
</head>
<body>
  <form id="studentForm">
    <h1>Nh·∫≠t k√Ω ng√†y h·ªçc c·ªßa b·∫°n</h1>

    <!-- B∆∞·ªõc 1 -->
    <div class="form-step active" id="step1">
      <label for="name">T√™n c·ªßa b·∫°n</label>
      <input type="text" id="name" name="name" placeholder="Nh·∫≠p t√™n (ho·∫∑c ch·ªçn ·∫©n danh)">
      <label><input type="checkbox" id="anonymous" name="anonymous"> T√¥i mu·ªën ·∫©n danh</label>

      <label for="grade">B·∫°n ƒëang h·ªçc l·ªõp m·∫•y?</label>
      <select id="grade" name="grade">
        <option value="">-- Ch·ªçn l·ªõp --</option>
        <option>L·ªõp 6</option><option>L·ªõp 7</option><option>L·ªõp 8</option><option>L·ªõp 9</option>
        <option>L·ªõp 10</option><option>L·ªõp 11</option><option>L·ªõp 12</option>
      </select>

      <label for="gender">Gi·ªõi t√≠nh</label>
      <select id="gender" name="gender">
        <option value="">-- Ch·ªçn --</option>
        <option>Nam</option><option>N·ªØ</option><option>Kh√°c</option><option>Kh√¥ng mu·ªën tr·∫£ l·ªùi</option>
      </select>

      <button type="button" onclick="nextStep(1)">Ti·∫øp t·ª•c</button>
    </div>

    <!-- B∆∞·ªõc 2 -->
    <div class="form-step" id="step2">
      <label for="mood">H√¥m nay b·∫°n c·∫£m th·∫•y th·∫ø n√†o? (1-5)</label>
      <input type="range" id="mood" name="mood" min="1" max="5" value="3">
      <p>T√¢m tr·∫°ng: <span id="moodValue">3</span> / 5</p>
      <div class="emoji" id="moodEmoji">üòê</div>

      <label for="bestPart">B·∫°n th√≠ch nh·∫•t ƒëi·ªÅu g√¨ trong ng√†y h√¥m nay?</label>
      <input type="text" id="bestPart" name="bestPart">

      <label for="notGood">C√≥ ƒëi·ªÅu g√¨ l√†m b·∫°n ch∆∞a vui ho·∫∑c m·ªát m·ªèi?</label>
      <input type="text" id="notGood" name="notGood">

      <button type="button" onclick="prevStep(2)">Quay l·∫°i</button>
      <button type="button" onclick="nextStep(2)">Ti·∫øp t·ª•c</button>
    </div>

    <!-- B∆∞·ªõc 3 -->
    <div class="form-step" id="step3">
      <label for="learned">B·∫°n h·ªçc ƒë∆∞·ª£c ƒëi·ªÅu g√¨ m·ªõi h√¥m nay?</label>
      <input type="text" id="learned" name="learned">

      <label for="selfNote">B·∫°n mu·ªën nh·∫Øn g√¨ v·ªõi b·∫£n th√¢n m√¨nh v√†o cu·ªëi ng√†y h√¥m nay?</label>
      <textarea id="selfNote" name="selfNote" rows="3"></textarea>

      <label><input type="checkbox" id="shareWithTeacher" name="shareWithTeacher"> Chia s·∫ª k·∫øt qu·∫£ v·ªõi gi√°o vi√™n</label>
      <label><input type="checkbox" id="wantSuggestion" name="wantSuggestion"> T√¥i mu·ªën nh·∫≠n m·ªôt g·ª£i √Ω t√≠ch c·ª±c</label>

      <button type="button" onclick="prevStep(3)">Quay l·∫°i</button>
      <button type="submit">Ho√†n th√†nh</button>
    </div>
  </form>

  <!-- Popup hi·ªÉn th·ªã k·∫øt qu·∫£ -->
<div id="resultModal" class="modal hidden">
  <div class="modal-content">
    <span id="closeModal" class="close">&times;</span>
    <div id="loadingSpinner" class="spinner hidden"></div>
    <div id="resultText"></div>
  </div>
</div>

  <script>
    let currentStep = 1;
    function showStep(step) {
      document.querySelectorAll(".form-step").forEach(div => div.classList.remove("active"));
      document.getElementById("step" + step).classList.add("active");
      currentStep = step;
    }
    function nextStep(step) { showStep(step + 1); }
    function prevStep(step) { showStep(step - 1); }

    // C·∫≠p nh·∫≠t emoji
    const moodInput = document.getElementById("mood");
    const moodValue = document.getElementById("moodValue");
    const moodEmoji = document.getElementById("moodEmoji");
    const emojis = { 1:"üò¢", 2:"üòü", 3:"üòê", 4:"üôÇ", 5:"üòÑ" };
    moodInput.addEventListener("input", () => {
      moodValue.textContent = moodInput.value;
      moodEmoji.textContent = emojis[moodInput.value];
    });

    // Submit form
document.getElementById("studentForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  // L·∫•y d·ªØ li·ªáu hi·ªán c√≥ tr√™n form (n·∫øu input t·ªìn t·∫°i s·∫Ω l·∫•y, n·∫øu kh√¥ng s·∫Ω ƒë·∫∑t m·∫∑c ƒë·ªãnh)
  const learning = (document.getElementById("learning")?.value || "").trim();
  const message = (document.getElementById("message")?.value || "").trim();

  // N·∫øu b·∫°n c√≥ c√°c field kh√°c (n·∫øu d√πng form nhi·ªÅu field), script s·∫Ω l·∫•y ch√∫ng, c√≤n kh√¥ng s·∫Ω d√πng m·∫∑c ƒë·ªãnh
  const nameEl = document.getElementById("name");
  const anonymousEl = document.getElementById("anonymous");
  const gradeEl = document.getElementById("grade");
  const genderEl = document.getElementById("gender");
  const moodEl = document.getElementById("mood");
  const bestPartEl = document.getElementById("bestPart");
  const notGoodEl = document.getElementById("notGood");
  const learnedEl = document.getElementById("learned").value;
  const selfNoteEl = document.getElementById("selfNote").value;
  const shareEl = document.getElementById("shareWithTeacher");
  const wantSuggestionEl = document.getElementById("wantSuggestion");

  const name = anonymousEl?.checked ? "·∫®n danh" : (nameEl?.value || "·∫®n danh");
  const grade = gradeEl?.value || "";
  const gender = genderEl?.value || "";
  const mood = moodEl ? Number(moodEl.value || 3) : 3;
  const bestPart = bestPartEl?.value || "";
  const notGood = notGoodEl?.value || "";
  const learned = learnedEl?.value || "";
  const selfNote = selfNoteEl?.value || "";
  const shareWithTeacher = !!(shareEl?.checked);
  const wantSuggestion = !!(wantSuggestionEl?.checked);

  // T·∫°o payload ph√π h·ª£p v·ªõi backend StudentData
  const payload = {
    name,
    grade,
    gender,
    mood,
    bestPart,
    notGood,
    learned,    // map input "learning" -> backend.learned
    selfNote,    // map input "message" -> backend.selfNote
    shareWithTeacher,
    wantSuggestion
  };

  // UI: show modal + spinner
  const modal = document.getElementById("resultModal");
  const spinner = document.getElementById("loadingSpinner");
  const resultText = document.getElementById("resultText");
  resultText.innerHTML = "";
  modal.classList.remove("hidden");
  spinner.classList.remove("hidden");

  try {
    // CH√ö √ù: d√πng c√πng host v·ªõi uvicorn. N·∫øu b·∫°n ch·∫°y uvicorn tr√™n 127.0.0.1:8000, d√πng 127.0.0.1
    const API_URL = "https://cogiaoai.onrender.com/submit";

    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      // l·∫•y body tr·∫£ v·ªÅ (th∆∞·ªùng ch·ª©a message l·ªói) ƒë·ªÉ debug
      const txt = await res.text();
      throw new Error(`Server l·ªói ${res.status}: ${txt}`);
    }

    const data = await res.json();

    // ·∫®n spinner
    spinner.classList.add("hidden");

    // H·ªó tr·ª£ nhi·ªÅu ki·ªÉu response t·ª´ backend (analysis string/object, reply, ...)
    let output = "";
    if (data.analysis) {
      if (typeof data.analysis === "string") output = data.analysis;
      else if (typeof data.analysis === "object") {
        // ∆∞u ti√™n tr∆∞·ªùng summary ho·∫∑c mood/score n·∫øu c√≥
        output = data.analysis.summary || data.analysis.mood || JSON.stringify(data.analysis, null, 2);
      } else output = String(data.analysis);
    } else if (data.reply) {
      output = data.reply;
    } else if (data.result) {
      output = data.result;
    } else {
      output = JSON.stringify(data);
    }

    // Hi·ªÉn th·ªã ƒë·∫πp trong modal
    resultText.innerHTML = "<div style='white-space:pre-wrap; line-height:1.6;'>" + output + "</div>";

  } catch (err) {
    spinner.classList.add("hidden");
    resultText.innerHTML = `<p style="color:red">L·ªói: ${err.message}</p>`;
    console.error("Submit error:", err);
  }
});

// ƒê√≥ng popup khi nh·∫•n X
document.getElementById("closeModal").onclick = function() {
  document.getElementById("resultModal").classList.add("hidden");
};
</script>

</body>
</html>



